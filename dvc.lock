schema: '2.0'
stages:
  download_and_extract_osm:
    cmd: wget -c --limit-rate=10M -P data/
      "https://download.geofabrik.de/russia/central-fed-district-latest.osm.pbf"
      && osmium extract --bbox "37.56895,55.71783,37.65015,55.76943"
      data/central-fed-district-latest.osm.pbf --output data/map.osm.pbf
    params:
      params.yaml:
        prepare_satellite_data.map_box:
        - 37.56895
        - 55.71783
        - 37.65015
        - 55.76943
        prepare_satellite_data.osm: data/map.osm.pbf
    outs:
    - path: data/central-fed-district-latest.osm.pbf
      hash: md5
      md5: cd0df8b935dc98398630eb190b8c796c
      size: 854716052
    - path: data/map.osm.pbf
      hash: md5
      md5: 168603d4f5b580339f484b32570bfe5f
      size: 7060009
  prepare_satellite_data:
    cmd: python scripts/prepare_satellite_data.py
    params:
      params.yaml:
        prepare_satellite_data:
          classes:
          - - road
            - 204
          - - building
            - 255
          - - parking
            - 153
          - - water
            - 102
          - - field
            - 51
          data_dir: data/satellite
          max_workers: 5
          zoom: 17
          num_tiles: 10
          tile_size: 256
          chunk_h: 2560
          chunk_w: 2560
          chunk_c: 5
          dataset_dir: data/dataset
          hdf: layers.hdf
          map_box:
          - 37.56895
          - 55.71783
          - 37.65015
          - 55.76943
          osm: data/map.osm.pbf
          sources:
            google: http://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}
            bing: http://a0.ortho.tiles.virtualearth.net/tiles/a{}.jpeg?g=2
            arcgis:
              https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}
            yandex: https://sat04.maps.yandex.net/tiles?l=sat&x={x}&y={y}&z={z}
    outs:
    - path: data/satellite
      hash: md5
      md5: 948b11940b09a76a9fb184296fb9a11c.dir
      size: 63648350
      nfiles: 45
  prepare_dataset:
    cmd: python scripts/prepare_dataset.py
    params:
      params.yaml:
        prepare_satellite_data:
          classes:
          - - road
            - 204
          - - building
            - 255
          - - parking
            - 153
          - - water
            - 102
          - - field
            - 51
          data_dir: data/satellite
          max_workers: 5
          zoom: 17
          num_tiles: 10
          tile_size: 256
          chunk_h: 2560
          chunk_w: 2560
          chunk_c: 5
          dataset_dir: data/dataset
          hdf: layers.hdf
          map_box:
          - 37.56895
          - 55.71783
          - 37.65015
          - 55.76943
          osm: data/map.osm.pbf
          sources:
            google: http://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}
            bing: http://a0.ortho.tiles.virtualearth.net/tiles/a{}.jpeg?g=2
            arcgis:
              https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}
            yandex: https://sat04.maps.yandex.net/tiles?l=sat&x={x}&y={y}&z={z}
    outs:
    - path: data/dataset
      hash: md5
      md5: d64c27b4ceb4119fb1310ce8ef1c3ec7.dir
      size: 884740616
      nfiles: 1
